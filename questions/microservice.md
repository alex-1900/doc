# 微服务

- [微服务](#微服务)
  - [什么是微服务](#什么是微服务)
  - [微服务的特点](#微服务的特点)
  - [微服务之间是如何通讯的](#微服务之间是如何通讯的)
    - [REST和RPC的区别](#rest和rpc的区别)
  - [服务发现的两种模式](#服务发现的两种模式)
  - [分布式系统面临的问题](#分布式系统面临的问题)
  - [服务降级与服务熔断的区别](#服务降级与服务熔断的区别)
  - [什么是幂等性](#什么是幂等性)
  - [超时重试如何保证数据不重复](#超时重试如何保证数据不重复)
  - [什么是蓝绿发布](#什么是蓝绿发布)
  - [什么是金丝雀发布](#什么是金丝雀发布)
  - [什么是滚动发布](#什么是滚动发布)
  - [A/B测试和金丝雀发布的区别](#ab测试和金丝雀发布的区别)
  - [服务的拆分原则](#服务的拆分原则)

### 什么是微服务
微服务架构是一种架构风格，提倡将单一应用程序划分成一组小的服务，服务之间互相协调配合。
每个服务都封装着具体业务，独立进行部署构建，服务可以使用不同的语言和组件来实现。

一般的微服务由：服务注册与发现，网关，配置中心，消息中心（消息总线），断路器 组成。

### 微服务的特点
低耦合，组件化，单一职责，自治，持续交付，分散治理

### 微服务之间是如何通讯的
- 同步调用   
例如 REST、gRPC、Thrift；优点是简单，常见，因为没有中间件代理，系统更简单。
缺点是只支持请求/响应的模式，降低了可用性，因为客户端和服务端在请求过程中必须都是可用的。

- 消息服务   
例如 Kafka、RabbitMQ；优点是松耦合，提高可用性，支持很多通信机制，例如通知、发布/订阅。
缺点是消息中间件有额外的复杂性，使系统整体变的复杂。

#### REST和RPC的区别
RPC 的隐藏了远程调用这一动作，让用户感觉在调用本地方法。
可以选择多种协议，性能往往比 REST 要好，吐量比较大，响应时间小。适合内部服务之间的通信。

REST 是标准的 HTTP 协议，相对来说更标准，更通用，天然支持所有语言，很适合对外开放的 API。
而且调用及测试都很方便。

### 服务发现的两种模式
- 客户端发现模式   
客户端负责确定服务提供者的地址和负载均衡策略，客户端访问服务注册表，定时同步目标服务的实例地址列表，然后选择目标服务的一个可用实例地址发送请求。

优点：可以实现中心化的通讯，避开单点造成的性能瓶颈；客户端可以自己制定负载均衡策略，相对比较灵活。

缺点：服务客户端与服务注册表耦合；SDK 对客户端代码存在入侵。

- 服务端发现模式   
客户端通过负载均衡器访问目标服务，负载均衡器负责查询服务注册表并转发请求。Docker 和 K8S 都具有内置的服务注册表和服务发现机制。

优点：部署平台提供服务发现功能，服务和客户端都得到简化；服务发现功能的更新对客户端是无感知的。

缺点：后端增加了一次请求转发，增加了运维难度，负载均衡器可能成为性能瓶颈；如果服务发现功能不可用，会导致整个系统瘫痪。

### 分布式系统面临的问题
复杂的分布式服务之间有很多依赖关系，从而引发多种问题：
- 服务雪崩   
fanout（调用关系：A->B->C）中的一环响应缓慢拖慢下游服务，导致资源越占越多，引发服务雪崩。
- 级联故障   
某个依赖服务故障导致其他服务崩溃。

解决方案是：
1. 服务熔断   
某个微服务不可用或者响应时间太长时，则会熔断该节点，快速返回客户端能够处理的”错误”的响应信息
2. 服务降级   
在系统层面熔断某个或某一组服务，将资源留给更重要的业务。

### 服务降级与服务熔断的区别
- 触发原因不大一样。服务熔断一般是某个下游服务发生故障引起，而服务降级一般是从整体负荷考虑。
- 管理目标层次不一样。熔断是一个框架级的处理，每个服务都需要，无层级之分，而降级一般需要对业务有层级之分。

### 什么是幂等性
幂等性是能够以同样的方式做两次，而对系统的影响保持不变，就好像它只做了一次的特性。

### 超时重试如何保证数据不重复
需要做到幂等：
- token机制   
请求前获取token，并存入 redis 中；请求时将带上 token，业务接口检测 token 是否存在redis 中，存在表示第一次，不存在表示重复提交，直接返回重复标记给客户端。执行完毕后业务接口删除 redis 中的 token.
- 版本号机制   
```sql
update user set point = point + 20, version = version + 1 where userid=1 and version=1
```
数据库的写操作是原子性的，加上版本号即可实现幂等。

### 什么是蓝绿发布
https://blog.csdn.net/lijiaocn/article/details/84276591

### 什么是金丝雀发布
https://blog.csdn.net/lijiaocn/article/details/84276591
http://www.mabiji.com/wiki/canary.html

开始时，使用HTTP Header 匹配指定测试人员的流量到新版本上，然后当新版本内部测试通过后，可以再按百分比，将用户流量一点一点导入到新版本中观察一下运行情况，直到将流量全部导入到新版本上，最后完成升级；发现问题，就立即取消升级，将流量切回到老版本。

### 什么是滚动发布
每次只升级一个或多个服务（非全部），加入生产环境；不断执行这个过程，直到集群中的全部旧版本完成升级。
优点：节约资源，用户无感知。
缺点：部署时间慢，发布策略较复杂，不好验证服务，不宜回滚。

### A/B测试和金丝雀发布的区别
金丝雀是发布策略，目标是确保新上线的系统稳定，关注的是新系统的BUG、隐患。
A/B测试是效果测试，同一时间有多个版本的服务对外开放，这些服务都达到了上线标准，A/B测试关注的是不同版本的服务效果（业务上的）。

### 服务的拆分原则
- 单一职责
- 避免环形依赖和双向依赖
- 服务粒度适中
- 演进式拆分
- 尽量避免分布式事务

总体原则：当一个业务不依赖或极少依赖其他服务，有独立的业务语义，为超过两个其他服务提供接口，那就应该拆分为独立服务，还应当与业务人员协同工作。
